name: Build APP
on:
  workflow_dispatch:

  push:
    branches:
      - master

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: âš™ï¸ Force Manual Submodule Update (Ensures file availability)
        # è¿™ä¸€æ­¥æ˜¯å…³é”®ï¼Œæ˜ç¡®æ‰§è¡Œ git submodule update ä»¥é˜² checkout æ­¥éª¤é—æ¼
        run: git submodule update --init --recursive

      - name: ğŸ” Verify Critical Submodule File (lz4.c)
        # éªŒè¯ CMake éœ€è¦çš„ lz4.c æ–‡ä»¶æ˜¯å¦åœ¨æ­£ç¡®çš„ä½ç½®
        run: |
          set -ex
          TARGET_FILE="externals/core/ext/lz4/lz4.c"
          
          echo "--- Listing contents of: externals/core/ext/ ---"
          # åˆ—å‡ºç›®æ ‡ç›®å½•çš„å†…å®¹ä»¥è¿›è¡Œå¯è§†åŒ–æ£€æŸ¥
          ls -F externals/core/ext/lz4/ || echo "Directory 'externals/core/ext/lz4' not found."

          echo "--- Checking for existence of ${TARGET_FILE} ---"
          if [ -f "$TARGET_FILE" ]; then
            echo "âœ… SUCCESS: The required C source file was found at ${TARGET_FILE}."
          else
            echo "âŒ FAILURE: The required C source file IS MISSING. CMake will fail."
            # å¦‚æœæ–‡ä»¶ç¡®å®ç¼ºå¤±ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ  'exit 1' æ¥æå‰ä¸­æ–­æ„å»º
            # exit 1 
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 'latest'
          log-accepted-android-sdk-licenses: 'false'
          packages: 'tools platform-tools cmake;3.31.5 platforms;android-35 ndk;28.0.13004108'

      - name: ğŸ§¹ Clean Gradle/CMake Cache
        # æ¸…ç†ä¹‹å‰çš„ç¼“å­˜å’Œé…ç½®ï¼Œç¡®ä¿ CMake é‡æ–°è¿è¡Œé…ç½®æ­¥éª¤
        run: ./gradlew clean
        
      - name: Build APK
        run: ./gradlew :app:assembleRelease

      - name: display dir tree
        run: |
          set -o pipefail
          set -ex
          sudo tree --filelimit 20 || true

      - uses: actions/upload-artifact@v4
        name: Upload APK
        with:
          name: App bundle
          path: app/build/outputs/apk/release/app-release.apk
